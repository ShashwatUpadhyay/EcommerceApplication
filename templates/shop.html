{% extends "index.html" %}
{% block title %}Ecommerce Home page{% endblock title %}
{% block stylesheet %}
#search-results {
    position: absolute;
    top: 100%; /* Position right below input */
    left: 0;
    z-index: 50; /* Ensure it appears above other elements */
    background-color: white;
    max-height: 200px; /* Prevent overflow */
    overflow-y: auto; /* Enable scrolling if too many results */
    display: none; /* Initially hidden */
}

{% endblock stylesheet %}

{% block content %}

<div class="bg-gray-100 min-h-screen">

    <div class="container mx-auto p-4 flex flex-col md:flex-row gap-4">
        
        <!-- Sidebar -->
        <aside class="h-full sticky top-2 left-0 md:w-1/4 bg-white p-4 rounded-lg shadow-md transition-all duration-300 transform md:translate-x-0"
            id="sidebar">
            <h2 class="text-lg font-semibold mb-4 flex justify-between items-center">
                Sort    
                <button class="md:hidden text-gray-600" onclick="toggleSidebar()">✖</button>
            </h2>

            <form class="max-w-full ml-auto mb-3" id="sortForm" method="get">
                {% if request.GET.category %}
                <input type="hidden" name="category" value="{{ request.GET.category }}">
                {% endif %}
                {% if request.GET.s %}
                <input type="hidden" name="s" value="{{ request.GET.s }}">
                {% endif %}
                <select id="countries" name="sort" onchange="document.getElementById('sortForm').submit();" class="bg-gray-50 w-full border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-100 dark:border-gray-600 dark:placeholder-gray-400 dark:text-black dark:focus:ring-blue-500 dark:focus:border-blue-500">
                  <option disabled {% if not request.GET.sort %}selected{% endif %}>Sort By</option>
                  <option {% if request.GET.sort == 'new'|stringformat:"s" %}selected{% endif %} value="new">Newest Arrivals</option>
                  <option {% if request.GET.sort == 'az'|stringformat:"s" %}selected{% endif %} value="az">Name (A - Z)</option>
                  <option {% if request.GET.sort == 'lh'|stringformat:"s" %}selected{% endif %} value="lh">Price - Low to High</option>
                  <option {% if request.GET.sort == 'hl'|stringformat:"s" %}selected{% endif %} value="hl">Price - High to Low</option>
                </select>
              </form>              
            <h2 class="text-lg font-semibold mb-4 flex justify-between items-center">
                Category    
                <button class="md:hidden text-gray-600" onclick="toggleSidebar()">✖</button>
            </h2>

            <!-- Category Dropdown -->

            <form id="filterForm" method="GET" action="{% url 'shop' %}">
                {% if request.GET.sort %}
                <input type="hidden" name="sort" value="{{ request.GET.sort }}">
                {% endif %}
                {% if request.GET.s %}
                <input type="hidden" name="s" value="{{ request.GET.s }}">
                {% endif %}

                <details class="mb-4">
                    <summary class="cursor-pointer font-medium text-gray-700 flex float-center">
                        <input type="radio" id="category" name="category" value="all" onchange="document.getElementById('filterForm').submit();"
                        {% if request.GET.category == 'all'|stringformat:"s" %}checked{% endif %}> 
                        <span class="float-left ml-3">All Products</span>

                    </summary>
                </details>

                {% for category in categories %}
                <details class="mb-4 group">
                    <summary class="cursor-pointer justify font-medium text-gray-700 flex  float-center">
                        
                        <input type="radio" id="category" name="category" value="{{ category.slug }}" onchange="document.getElementById('filterForm').submit();"
                        {% if request.GET.category == category.slug|stringformat:"s" %}checked{% endif %} placeholder="{{ category.name }}"> 
                        <span class="float-left ml-3">{{ category.name }}</span>
                        {% if category.sub_category %}
                        <span class="ml-[10px] transition-transform duration-200 group-open:rotate-180  ">
                            <svg height='25' viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M7 10L12 15L17 10" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                        </span>
                        {% endif %}
                    </summary>
                    {% if category.sub_category %}
                      
                    <div class="mt-2 space-y-2 pl-4">
                        {% for sub in category.sub_category.all %}
                        <label class="flex items-center cursor-pointer">
                            <input id="category" type="radio" name="category" value="{{ sub.slug }}" class="mr-2 text-blue-500 focus:ring-2"
                                onchange="document.getElementById('filterForm').submit();"
                                {% if request.GET.category == sub.slug|stringformat:"s" %}checked{% endif %}>
                            <span class="text-gray-700 hover:text-blue-500 transition">{{ sub.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    {% endif %}

                </details>
                {% endfor %}
            </form>
        </aside>

        <!-- Mobile Sidebar Toggle Button -->
        <button class="md:hidden bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md"
            onclick="toggleSidebar()">☰ Filters</button>

        <!-- Products Section -->
        <div>
            
        <div class="flex z-100  relative w-full flex-row text-on-surface dark:text-on-surface-dark">
            <form class="flex items-center mb-2 w-full border border-gray-300 rounded-md overflow-hidden" id="search" method="get">
        {% if request.GET.sort %}
                <input type="hidden" name="sort" value="{{ request.GET.sort }}">
                {% endif %}
                <div class="relative flex-grow">
                    <input type="text" name="s" id="search-input"
                        class="w-full pl-10 pr-4 py-2 focus:ring focus:ring-blue-300 focus:outline-none"
                        placeholder="Search...">
                    <span class="absolute left-3 top-2 text-gray-400">
                        <svg height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19.9604 11.4802C19.9604 13.8094 19.0227 15.9176 17.5019 17.4512C16.9332 18.0247 16.2834 18.5173 15.5716 18.9102C14.3594 19.5793 12.9658 19.9604 11.4802 19.9604C6.79672 19.9604 3 16.1637 3 11.4802C3 6.79672 6.79672 3 11.4802 3C16.1637 3 19.9604 6.79672 19.9604 11.4802Z"
                                stroke="#333333" stroke-width="2"></path>
                            <path d="M18.1553 18.1553L21.8871 21.8871" stroke="#333333" stroke-width="2" stroke-linecap="round"></path>
                        </svg>
                    </span>
                </div>
            
                <!-- Search Button -->
                <button type="submit"
                    class="px-4 py-2 bg-blue-500 text-white hover:bg-blue-600 transition duration-200 focus:ring focus:ring-blue-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2"
                        viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21 21l-4.35-4.35m1.4-5.15a6.5 6.5 0 11-13 0 6.5 6.5 0 0113 0z"></path>
                    </svg>
                </button>
            </form>
            
            <ul id="search-results" class="absolute bg-white w-full border border-gray-300 rounded-md shadow-md mt-1 hidden"></ul>
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const searchInput = document.getElementById("search-input");
                    const resultsDropdown = document.getElementById("search-results");
                
                    searchInput.addEventListener("keyup", function () {
                        let query = searchInput.value.trim();
                
                        if (query.length > 1) {
                            fetch(`/shop/search/?s=${query}`)
                                .then(response => response.json())
                                .then(data => {
                                    resultsDropdown.innerHTML = ""; // Clear previous results
                                    resultsDropdown.style.display = "block"; // Show dropdown
                                    
                                    if (data.products.length > 0) {
                                        data.products.forEach(item => {
                                            let listItem = document.createElement("li");
                                            listItem.classList.add("p-2", "hover:bg-gray-100", "cursor-pointer", "flex", "items-center");
                                            
                                            function fetchImage(uid) {
                                                fetch(`/shop/image/${uid}/`)  
                                                    .then(response => response.json())  // Convert response to JSON
                                                    .then(data => {
                                                        if (data.image_url) {
                                                            document.getElementById(`product-image-${uid}`).src = data.image_url;  // Set image src
                                                        } else {
                                                            console.error("No image found");
                                                        }
                                                    })
                                                    .catch(error => console.error("Error fetching image:", error));
                                            }
                                            let listImg = document.createElement("img");
                                            listImg.src = fetchImage(item.image);
                                            listImg.alt = item.title;
                                            listImg.id = `product-image-${item.image}`;
                                            listImg.classList.add("w-10", "h-10", "rounded", "mr-3"); // Add styling (adjust as needed)
                                            let listText = document.createElement("span");
                                            listText.textContent = item.title;
                                            listItem.appendChild(listImg);
                                            listItem.appendChild(listText);
                                            listItem.onclick = function () {
                                                searchInput.value = item.title;
                                                resultsDropdown.style.display = "none";
                                                document.getElementById("search").submit()
                                                {% comment %} window.location.href=`/shop/${item.slug}/` // Submit form {% endcomment %}
                                            };
                                            resultsDropdown.appendChild(listItem);
                                        });
                                    }
                                    if (data.categories.length > 0) {
                                        data.categories.forEach(item => {
                                            let listItem = document.createElement("li");
                                            listItem.classList.add("p-2", "hover:bg-gray-100", "cursor-pointer", "flex", "items-center");
                                            let listImg = document.createElement("img");
                                            listImg.src = `/media/${item.img}`;
                                            console.log(listImg.src)
                                            listImg.alt = item.name;
                                            listImg.classList.add("w-10", "h-10", "rounded", "mr-3"); // Add styling (adjust as needed)
                                            let listText = document.createElement("span");
                                            listText.textContent = item.name + '  (category)';
                                            listItem.appendChild(listImg);
                                            listItem.appendChild(listText);
                                            listItem.onclick = function () {
                                                searchInput.value = item.slug;
                                                resultsDropdown.style.display = "none";
                                                window.location.href=`/shop/?category=${item.slug}`
                                            };
                                            resultsDropdown.appendChild(listItem);
                                        });
                                    } 
                                    if (data.subcategories.length > 0) {
                                        data.subcategories.forEach(item => {
                                            let listItem = document.createElement("li");
                                            listItem.classList.add("p-2", "hover:bg-gray-100", "cursor-pointer", "flex", "items-center");
                                            let listImg = document.createElement("img");
                                            listImg.src = 'https://plus.unsplash.com/premium_vector-1725881520027-886fd2125e64?q=80&w=1480&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D';
                                            console.log(listImg.src)
                                            listImg.alt = item.name;
                                            listImg.classList.add("w-10", "h-10", "rounded", "mr-3"); // Add styling (adjust as needed)
                                            let listText = document.createElement("span");
                                            listText.textContent = item.name + '  (sub category)';
                                            listItem.appendChild(listImg);
                                            listItem.appendChild(listText);
                                            listItem.onclick = function () {
                                                searchInput.value = item.slug;
                                                resultsDropdown.style.display = "none";
                                                window.location.href=`/shop/?category=${item.slug}`
                                            };
                                            resultsDropdown.appendChild(listItem);
                                        });
                                    } 
                                    
                                
                                })
                                .catch(error => console.error("Error fetching results:", error));
                        } else {
                            resultsDropdown.style.display = "none"; // Hide dropdown if query is short
                        }
                    });
                
                    // Hide dropdown when clicking outside
                    document.addEventListener("click", function (event) {
                        if (!searchInput.contains(event.target) && !resultsDropdown.contains(event.target)) {
                            resultsDropdown.style.display = "none";
                        }
                    });
                });
                </script>
                
        </div>
        <section class="md:w-3/4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Product Card -->
            {% if products %}
            {% for product in products %}
            <div class="block bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition">
            <a href="{% url 'product' product.slug %}" >
                <img src="{{ product.latest_image.img.url }}" alt="{{ product.title }}"
                    class="w-full h-48 object-cover rounded-lg">
                <h3 class="text-lg font-medium mt-2 text-gray-800">{{ product.title }}</h3>
                <p class=" font-small mt-2 text-gray-800">{{ product.category.name }}</p>
                <p class="text-gray-600">₹{{ product.price }}</p>
            </a>
            {% if product in request.user.extra.cart.cartitems.all %}
                <button onclick="window.location.href=`/order/add-to-cart/?product_id={{ product.uid }}`" class="mt-2 w-full flex bg-blue-500 justify-center text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                    <svg height='24' class='mx-2' viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M2 3L2.26491 3.0883C3.58495 3.52832 4.24497 3.74832 4.62248 4.2721C5 4.79587 5 5.49159 5 6.88304V9.5C5 12.3284 5 13.7426 5.87868 14.6213C6.75736 15.5 8.17157 15.5 11 15.5H19" stroke="#000000" stroke-width="1.5" stroke-linecap="round"></path> <path opacity="0.5" d="M7.5 18C8.32843 18 9 18.6716 9 19.5C9 20.3284 8.32843 21 7.5 21C6.67157 21 6 20.3284 6 19.5C6 18.6716 6.67157 18 7.5 18Z" stroke="#000000" stroke-width="1.5"></path> <path opacity="0.5" d="M16.5 18.0001C17.3284 18.0001 18 18.6716 18 19.5001C18 20.3285 17.3284 21.0001 16.5 21.0001C15.6716 21.0001 15 20.3285 15 19.5001C15 18.6716 15.6716 18.0001 16.5 18.0001Z" stroke="#000000" stroke-width="1.5"></path> <path d="M5 6H16.4504C18.5054 6 19.5328 6 19.9775 6.67426C20.4221 7.34853 20.0173 8.29294 19.2078 10.1818L18.7792 11.1818C18.4013 12.0636 18.2123 12.5045 17.8366 12.7523C17.4609 13 16.9812 13 16.0218 13H5" stroke="#000000" stroke-width="1.5"></path> </g></svg>
                    delete
                </button>
                {% else %}
                <button onclick="window.location.href=`/order/add-to-cart/?product_id={{ product.uid }}`" class="mt-2 w-full flex bg-blue-500 justify-center text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
                    <svg height='24' class='mx-2' viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M2 3L2.26491 3.0883C3.58495 3.52832 4.24497 3.74832 4.62248 4.2721C5 4.79587 5 5.49159 5 6.88304V9.5C5 12.3284 5 13.7426 5.87868 14.6213C6.75736 15.5 8.17157 15.5 11 15.5H19" stroke="#000000" stroke-width="1.5" stroke-linecap="round"></path> <path opacity="0.5" d="M7.5 18C8.32843 18 9 18.6716 9 19.5C9 20.3284 8.32843 21 7.5 21C6.67157 21 6 20.3284 6 19.5C6 18.6716 6.67157 18 7.5 18Z" stroke="#000000" stroke-width="1.5"></path> <path opacity="0.5" d="M16.5 18.0001C17.3284 18.0001 18 18.6716 18 19.5001C18 20.3285 17.3284 21.0001 16.5 21.0001C15.6716 21.0001 15 20.3285 15 19.5001C15 18.6716 15.6716 18.0001 16.5 18.0001Z" stroke="#000000" stroke-width="1.5"></path> <path d="M5 6H16.4504C18.5054 6 19.5328 6 19.9775 6.67426C20.4221 7.34853 20.0173 8.29294 19.2078 10.1818L18.7792 11.1818C18.4013 12.0636 18.2123 12.5045 17.8366 12.7523C17.4609 13 16.9812 13 16.0218 13H5" stroke="#000000" stroke-width="1.5"></path> </g></svg>
                    Add to Cart
                </button>
            {% endif %}
            </div>
            {% endfor %}
            {% else %}
            {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                <li{% if message.tags %} class="{% if message.tags == 'error' %}text-red-500{% endif %} {% if message.tags == 'success' %}text-green-500{% endif %}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
            {% endif %}
            {% endif %}

        </section>
        
    </div>
    
    </div>
    {% if products.paginator.num_pages >= 2 %}
<!-- ====== Pagination Section Start -->
<div class="bg-gray-100 py-10 text-center dark:bg-dark">
    <div>
      <ul
        class="mx-auto flex w-full max-w-[415px] items-center justify-between"
      >
        <li>
            {% if products.has_previous %}
          <a
          href='?page={{products.previous_page_number}}{% if request.GET.sort %}&sort={{request.GET.sort}}{% endif %}{% if request.GET.s %}&s={{request.GET.s}}{% endif %}{% if request.GET.category %}&category={{request.GET.category}}{% endif %}'
            class="inline-flex h-10 items-center justify-center gap-2 rounded-lg px-4 py-2 text-base font-medium text-dark hover:bg-gray-2 dark:text-black dark:hover:bg-white/5"
          >
            <span>
              <svg
                width="17"
                height="17"
                viewBox="0 0 17 17"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M11.325 14.825C11.175 14.825 11.025 14.775 10.925 14.65L5.27495 8.90002C5.04995 8.67502 5.04995 8.32503 5.27495 8.10002L10.925 2.35002C11.15 2.12502 11.5 2.12502 11.725 2.35002C11.95 2.57502 11.95 2.92502 11.725 3.15002L6.47495 8.50003L11.75 13.85C11.975 14.075 11.975 14.425 11.75 14.65C11.6 14.75 11.475 14.825 11.325 14.825Z"
                  fill="currentColor"
                />
              </svg>
            </span>
            <span class="max-sm:hidden"> Previous </span>
          </a>
          {% endif %}
        </li>
        <p class="text-base font-medium text-dark dark:text-dark">
          Page {{products.number}} to {{products.paginator.num_pages}}
        </p>
        <li>
            {% if products.has_next %}
          <a
          href='?page={{products.next_page_number}}{% if request.GET.sort %}&sort={{request.GET.sort}}{% endif %}{% if request.GET.s %}&s={{request.GET.s}}{% endif %}{% if request.GET.category %}&category={{request.GET.category}}{% endif %}'
            class="inline-flex h-10 items-center justify-center gap-2 rounded-lg px-4 py-2 text-base font-medium text-dark hover:bg-gray-2 dark:text-dark dark:hover:bg-white/5"
          >
            <span class="max-sm:hidden"> Next </span>
            <span>
              <svg
                width="17"
                height="17"
                viewBox="0 0 17 17"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M5.67495 14.825C5.52495 14.825 5.39995 14.775 5.27495 14.675C5.04995 14.45 5.04995 14.1 5.27495 13.875L10.525 8.50003L5.27495 3.15002C5.04995 2.92502 5.04995 2.57502 5.27495 2.35002C5.49995 2.12502 5.84995 2.12502 6.07495 2.35002L11.725 8.10002C11.95 8.32503 11.95 8.67502 11.725 8.90002L6.07495 14.65C5.97495 14.75 5.82495 14.825 5.67495 14.825Z"
                  fill="currentCOlor"
                />
              </svg>
            </span>
          </a>
          {% endif %}
        </li>
      </ul>
    </div>
  </div>
  <!-- ====== Pagination Section End -->
  {% endif %}
</div>

<!-- JavaScript for Sidebar Toggle -->
<script>
    function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("-translate-x-full");
    }
</script>

{% endblock content %}
